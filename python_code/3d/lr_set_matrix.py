import numpy as np
from VORTEXm import VORTEXm

def lr_set_matrix(iwing, Xt, nXt, XC, NC):
    """
    Set up a self-coefficient matrix for the nonpenetration condition on the 
    airfoil surface: coefficient matrix of normal vel by itself

    Parameters
    ----------
    iwing: int
        0 (right wing), 1 (left wing)
    Xt: ndarray[j, n, i]
        Coordinates of total elements on the wing
    nXt: int
        Number of total elements on the wing
    XC: ndarray[j, i]
        Coordinates of the total collocation points on the wing
    NC: ndarray[j, i]
        Unit normal at the total collocation points on the wing

    Returns
    -------
    VN: ndarray[nXt, nXt]
        Matrix for the nonpenetration condition
    """
    # The left wing geometry is obtained by reversing the sign of the 
    # y-coordinate of the right wing
    if iwing == 1:
        Xt[1, :, :] = -Xt[1, :, :]
        XC[1, :] = -XC[1, :]
        NC[1, :] = -NC[1, :]

    VN = np.zeros((nXt, nXt))
    s = np.shape(XC)
    
    for i in range(nXt):
        U = np.zeros((1, s[1]))
        V = np.zeros((1, s[1]))
        W = np.zeros((1, s[1]))

        dU, dV, dW = VORTEXm(XC[0, :], XC[1, :], XC[2, :], 
                             Xt[0, 0, i], Xt[1, 0, i], Xt[2, 0, i], 
                             Xt[0, 1, i], Xt[1, 1, i], Xt[2, 1, i], 
                             1.0)
        U = U + dU
        V = V + dV
        W = W + dW

        dU, dV, dW = VORTEXm(XC[0, :], XC[1, :], XC[2, :], 
                             Xt[0, 1, i], Xt[1, 1, i], Xt[2, 1, i], 
                             Xt[0, 2, i], Xt[1, 2, i], Xt[2, 2, i], 
                             1.0)
        U = U + dU
        V = V + dV
        W = W + dW

        dU, dV, dW = VORTEXm(XC[0, :], XC[1, :], XC[2, :], 
                             Xt[0, 2, i], Xt[1, 2, i], Xt[2, 2, i], 
                             Xt[0, 3, i], Xt[1, 3, i], Xt[2, 3, i], 
                             1.0)
        U = U + dU
        V = V + dV
        W = W + dW

        dU, dV, dW = VORTEXm(XC[0, :], XC[1, :], XC[2, :], 
                             Xt[0, 3, i], Xt[1, 3, i], Xt[2, 3, i], 
                             Xt[0, 0, i], Xt[1, 0, i], Xt[2, 0, i], 
                             1.0)
        U = U + dU
        V = V + dV
        W = W + dW

        # Normal velocity
        VN[:, i] = (U * NC[0, :] + V * NC[1, :] + W * NC[2, :])

    return VN


if __name__ == "__main__":
    iwing = 0   # Change to 1 for the iwing check
                # Then, manually change iwing to 2 in Matlab debugger
    nXt = 17

    NC = np.zeros((3, nXt))
    NC[2, :] = 1

    XC = np.array([
        [-0.0298819853229070, -0.0851504735837784, -0.110536976521743, -0.110536976521743, -0.0552684882608715, 0.0552684882608715, 0.110536976521743, 0.110536976521743, 0.0851504735837784, 0.0298819853229070, 1.70445411676235e-18, -0.0368456588405810, 0.0368456588405810, -0.0491275451207746, 0.0491275451207746, -0.0491275451207746, 0.0491275451207746],
        [ 0.0763208893706897,  0.172048719096043 ,  0.271287920271966,  0.386320379178651,  0.446084349824465 , 0.446084349824465 , 0.386320379178651, 0.271287920271966, 0.172048719096043	, 0.0763208893706896, 0.112946098271010	  ,  0.176764651421246 , 0.176764651421246 ,  0.272933381027120 , 0.272933381027120 ,  0.380179436038554 , 0.380179436038554 ],
        [ 0	                ,  0	             ,  0	             ,  0	             ,  0	              , 0	              , 0	             , 0	            , 0	                , 0	                , 0	                  ,  0	               , 0	               ,  0	                , 0	                ,  0	             , 0                 ]
    ])

    Xt = np.zeros((3, 4, nXt))
    Xt[:, :, 0] = [
        [0,   -0.0704,   -0.0491,    0.0000],
        [0,    0.1219,    0.1342,    0.0491],
        [0,         0,         0,         0],
    ]

    Xt[:, :, 1] = [
        [-0.0704,   -0.1228,   -0.0983,   -0.0491],
        [ 0.1219,    0.2127,    0.2193,    0.1342],
        [      0,         0,         0,         0],
    ]

    Xt[:, :, 2] = [
        [-0.1228,   -0.1228,   -0.0983,   -0.0983],
        [ 0.2127,    0.3266,    0.3266,    0.2193],
        [      0,         0,         0,         0],
    ]

    Xt[:, :, 3] = [
        [-0.1228,   -0.1228,   -0.0983,   -0.0983],
        [ 0.3266,    0.4584,    0.4338,    0.3266],
        [      0,         0,         0,         0],
    ]

    Xt[:, :, 4] = [
        [-0.1228,    0.0000,    0.0000,   -0.0983],
        [ 0.4584,    0.4584,    0.4338,    0.4338],
        [      0,         0,         0,         0],
    ]

    Xt[:, :, 5] = [
        [0.0000,    0.1228,    0.0983,    0.0000],
        [0.4584,    0.4584,    0.4338,    0.4338],
        [     0,         0,         0,         0],
    ]

    Xt[:, :, 6] = [
        [0.1228,    0.1228,    0.0983,    0.0983],
        [0.4584,    0.3266,    0.3266,    0.4338],
        [     0,         0,         0,         0],
    ]

    Xt[:, :, 7] = [
        [0.1228,    0.1228,    0.0983,    0.0983],
        [0.3266,    0.2127,    0.2193,    0.3266],
        [     0,         0,         0,         0],
    ]

    Xt[:, :, 8] = [
        [0.1228,    0.0704,    0.0491,    0.0983],
        [0.2127,    0.1219,    0.1342,    0.2193],
        [     0,         0,         0,         0],
    ]

    Xt[:, :, 9] = [
        [0.0704,    0.0000,    0.0000,    0.0491],
        [0.1219,   -0.0000,    0.0491,    0.1342],
        [     0,         0,         0,         0],
    ]

    Xt[:, :, 10] = [
        [     0,   -0.0491,         0,    0.0491],
        [0.0491,    0.1342,    0.1342,    0.1342],
        [     0,         0,         0,         0],
    ]

    Xt[:, :, 11] = [
        [-0.0491,   -0.0983,    0.0000,    0.0000],
        [ 0.1342,    0.2193,    0.2193,    0.1342],
        [      0,         0,         0,         0],
    ]

    Xt[:, :, 12] = [
        [0.0000,    0.0000,    0.0983,    0.0491],
        [0.1342,    0.2193,    0.2193,    0.1342],
        [     0,         0,         0,         0],
    ]

    Xt[:, :, 13] = [
        [-0.0983,   -0.0983,    0.0000,    0.0000],
        [ 0.2193,    0.3266,    0.3266,    0.2193],
        [      0,         0,         0,         0],
    ]

    Xt[:, :, 14] = [
        [0.0000,    0.0000,    0.0983,    0.0983],
        [0.2193,    0.3266,    0.3266,    0.2193],
        [     0,         0,         0,         0],
    ]

    Xt[:, :, 15] = [
        [-0.0983,   -0.0983,    0.0000,    0.0000],
        [ 0.3266,    0.4338,    0.4338,    0.3266],
        [      0,         0,         0,         0],
    ]

    Xt[:, :, 16] = [
        [0.0000,    0.0000,    0.0983,    0.0983],
        [0.3266,    0.4338,    0.4338,    0.3266],
        [     0,         0,         0,         0],
    ]

    lr_set_matrix(iwing, Xt, nXt, XC, NC) 
